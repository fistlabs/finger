#!/usr/bin/env node
'use strict';

var Benchmark = require('benchmark').Benchmark;
var Suite = Benchmark.Suite;
var suite = new Suite();

Benchmark.options.minSamples = 100;

var SusaninRouter = require('susanin');
var FingerMatcher = require('../core/matcher');
var FingerRule = require('../core/rule');
var SusaninRoute = SusaninRouter.Route;

var susaninRouter = new SusaninRouter();
var fingerMatcher = new FingerMatcher();

susaninRouter.addRoute('/');
susaninRouter.addRoute('/news/(<postId>/)');
susaninRouter.addRoute('/upload/');
susaninRouter.addRoute('/forum/');

fingerMatcher.addRule('/');
fingerMatcher.addRule('/news/(<postId>/)');
fingerMatcher.addRule('/upload/');
fingerMatcher.addRule('/forum/');

var susaninRoute = new SusaninRoute('/news/(<postId>/)');
var fingerRule = new FingerRule('/news/(<postId>/)');

function benchSusaninRouteMatch() {
    global.__test__ = susaninRoute.match('/foo/bar/');
    global.__test__ = susaninRoute.match('/news/42/');
    global.__test__ = susaninRoute.match('/news/42/?a=42');
    global.__test__ = susaninRoute.match('/news/');
    global.__test__ = susaninRoute.match('/news/?a=42');
}

function benchFingerRuleMatch() {
    global.__test__ = fingerRule.match('/foo/bar/');
    global.__test__ = fingerRule.match('/news/42/');
    global.__test__ = fingerRule.match('/news/42/?a=42');
    global.__test__ = fingerRule.match('/news/');
    global.__test__ = fingerRule.match('/news/?a=42');
}

function benchSusaninRouteBuild() {
    global.__test__ = susaninRoute.build();
    global.__test__ = susaninRoute.build({
        postId: 42
    });
    global.__test__ = susaninRoute.build({
        x: 43
    });
    global.__test__ = susaninRoute.build({
        postId: 42,
        x: 43
    });
}

function benchFingerRuleBuild() {
    global.__test__ = fingerRule.build();
    global.__test__ = fingerRule.build({
        postId: 42
    });
    global.__test__ = fingerRule.build({
        x: 43
    });
    global.__test__ = fingerRule.build({
        postId: 42,
        x: 43
    });
}

function benchSusaninRouterFind() {
    global.__test__ = susaninRouter.find('/');
    global.__test__ = susaninRouter.find('/news/');
    global.__test__ = susaninRouter.find('/news/42/');
    global.__test__ = susaninRouter.find('/upload/');
    global.__test__ = susaninRouter.find('/forum/');
}

function benchFingerMatcherMatchAll() {
    global.__test__ = fingerMatcher.matchAll('/');
    global.__test__ = fingerMatcher.matchAll('/news/');
    global.__test__ = fingerMatcher.matchAll('/news/42/');
    global.__test__ = fingerMatcher.matchAll('/upload/');
    global.__test__ = fingerMatcher.matchAll('/forum/');
}

//  Warm up!
benchSusaninRouteMatch();
benchFingerRuleMatch();

benchSusaninRouteBuild();
benchFingerRuleBuild();

benchSusaninRouterFind();
benchFingerMatcherMatchAll();

suite.add('Susanin.Route#match', benchSusaninRouteMatch);
suite.add('finger/core/rule#match', benchFingerRuleMatch);

suite.add('Susanin.Route#build', benchSusaninRouteBuild);
suite.add('finger/core/rule#build', benchFingerRuleBuild);

suite.add('Susanin#find', benchSusaninRouterFind);
suite.add('finger/core/matcher#matchAll', benchFingerMatcherMatchAll);

suite.on('cycle', function (event) {
    console.log(String(event.target));
});

suite.on('complete', function () {
    console.log();
});

suite.run({
    queued: true,
    async: true
});
